# System Patterns

## システムアーキテクチャ
- Node.jsを使用してサーバーサイドのロジックを実装。
- モジュール分割によるコンポーネント化を採用し、機能ごとに独立したファイルを作成。

## キーテクニカルディシジョン
- Gmail APIを使用して、メールボックスの変更を監視。
- OAuth 2.0を使用して、ユーザー認証を実施。
- JSONファイルを使用して、お届け先マスタなどの設定情報を管理。
- HTMLテンプレートとPuppeteerを組み合わせたサーバーサイドPDF生成機能を実装し、CLIツールで呼び出せるようにした。

## デザインパターン
- 非同期プログラミングを活用し、効率的なAPI呼び出しを実現。
- トークンの管理と再利用を通じて、認証フローを最適化。
- データ変換パターンを使用して、Excelファイルのデータを適切な形式に整形。
- 冪等性（べきとうせい）パターンを実装し、同じファイルの重複処理を防止。
- アダプターパターンを使用して、異なるデータ形式（Excel形式とスプレッドシート形式）の間の変換を処理。
- テンプレートパターンを使用して、発注用ファイルの生成を実装。
- ファクトリーパターンを使用して、受注データから発注用ファイルを生成。
- リポジトリパターンを使用して、お届け先マスタの管理を実装。
- テンプレートエンジンパターンを使用して、HTMLテンプレートとデータを組み合わせて請求書を生成。
- ストラテジーパターンを採用し、スプレッドシート形式とHTML形式の請求書生成を切り替え可能に。
- コマンドパターンを使用して、`generateInvoice` CLIツールのオプション処理を実装。
- ファイルストレージパターンを採用し、生成した請求書を`billing/invoices`ディレクトリに保存。
- ファサードパターンを使用して、請求書生成プロセスの複雑さを隠蔽し、シンプルなインターフェースを提供。

## エラーハンドリング戦略
- 特殊文字や日本語を含むシート名の処理に関する問題を、固定値の使用で回避。
- try-catchブロックを使用して、API呼び出しのエラーを適切に処理。
- 詳細なログ出力を通じて、問題の診断と解決を容易に。
- お届け先マスタに存在しないデータの処理を、警告ログと空欄の使用で対応。
- ファイル操作エラーの検出と自動リカバリー（存在しないディレクトリの自動作成など）。
- クロスプラットフォーム対応のためのOS検出と適切なコマンド選択（ファイルオープン機能）。

## データ表示パターン
- 請求書のHTML生成にテンプレートベースの動的コンテンツ生成を採用。
- プレースホルダー置換パターンを使用して静的HTMLに動的データを挿入。
- 設定の外部化により、コードとデザインの分離を実現。
- レスポンシブデザインパターンを採用し、様々な画面サイズに対応。
- PDFエクスポート機能をクライアントサイドで実装し、サーバー負荷を軽減。
