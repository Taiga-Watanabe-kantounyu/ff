# Active Context

## 現在の作業内容
- Gmail APIを使用してメールボックスの変更を監視する機能を実装。
- Google Cloud Pub/Subを使用して、特定のトピックに対する変更を監視。
- `gmailWatcher.js`と`excelProcessor.js`を連携させ、Gmailの添付ファイルを自動的にGoogleスプレッドシートに転記するフローを実装。
- 受注フォーマットのデータを発注用フォーマットに転記する機能を実装。

## 最近の変更
- `gmailWatcher.js`の実行が成功し、Gmail APIへのアクセスが正常に行われたことを確認。
- ファイル名を`server.js`から`gmailWatcher.js`に変更。
- `excelProcessor.js`を`ff01-455323-24aa6cec6617.json`を使用して認証するように変更。
- `excelProcessor.js`を修正し、スプレッドシートの更新が成功した後に`processed_sheets.json`に処理済みのファイルを記録するように変更。
- `excelProcessor.js`を修正し、日本語のシート名に関連するエラーを解消するために、シート名を固定値「Sheet1」に設定。
- Excelファイルのデータを正しく処理し、C1セルから集荷日を取得してフォーマット仕様に従ってデータを整形する機能を追加。
- 処理済みのファイルを正しく記録し、重複処理を防止する機能を確認。
- `excelProcessor.js`を修正し、C1セルから取得した集荷日がYYYY/MM/DD形式で正しく処理されるように改善。Excelの日付が内部的な数値表現（シリアル値）として取得される問題を解決。
- 新たに`orderFileGenerator.js`を作成し、受注フォーマットのデータを発注用フォーマット（saito_irai.xlsx）に転記する機能を実装。
- お届け先の電話番号と住所を管理するための`deliveryMaster.json`を作成。
- お届け先マスタを管理するための`deliveryMasterManager.js`を作成し、追加/更新/削除/検索機能を実装。
- `gmailWatcher.js`を修正し、受信したExcelファイルから発注用ファイルも生成するように機能を追加。
- `orderFileGenerator.js`を修正し、発注用ファイル生成時にテンプレートファイル（saito_irai.xlsx）のセルスタイル情報を保持するように改善。これにより、発注書のレイアウトが正しく反映されるようになった。
- xlsxライブラリからexceljsライブラリに切り替え、文字サイズと罫線の問題を解決。
- CSVファイルからJSONマスタを生成する`csvToJson.js`を作成し、お届け先マスタ（deliveryMaster.json）を更新。電話番号情報も含めて変換するように対応。
+ 祝日API（holidays-jp）を実装し、レスポンスをメモリ内キャッシュして呼び出し回数を削減。
+ GmailWatcher→ExcelProcessor→OrderFileGenerator→PrintFileの処理パイプラインをオーケストレーションパターンで統合。
+ sendErrorMailモジュールへのエラー通知をオブザーバーパターンで実装。
+ invoice-config.jsを作成し、請求書設定（税率、会社情報、プリンタ設定など）を一元管理可能にしました。
+ `htmlTemplateRenderer.js`, `formatUtils.js`, `inv_temp.html`を用いたHTMLテンプレート請求書生成機能を実装。
+ `puppeteerInvoiceGenerator.js`を実装し、PuppeteerでサーバーサイドPDF請求書生成機能を追加。
+ generateInvoiceツールに `--puppeteer` オプションを追加し、Puppeteer出力をデフォルト化しました。
+ billing/invoices ディレクトリに請求書ファイルを保存するように変更しました。
+ printFile.js を実装し、請求書の自動印刷機能を追加（config.jsのプリンタ設定読み込み）。
+ config.js に MAIL_SEARCH_CONFIG および sheetName 設定を追加し、動的に読み込むように変更しました。

## 次のステップ
- メールボックスの変更通知のさらなるテストと検証。
- スプレッドシートのシート名の設定を設定ファイルから読み込むように改善。
- エラーハンドリングのさらなる強化とログ出力の改善。
- ドキュメントの更新と保守性の向上。
- お届け先マスタの拡充と管理機能の強化。

## 最新の修正
- `excelProcessor.js`を修正し、スプレッドシートの情報を取得して指定したシート名が実際に存在するかどうかを確認するようにしました。
- エラーハンドリングを強化し、より詳細なエラーメッセージを出力するようにしました。
- `config.js`のスプレッドシートIDを修正し、正しいIDに更新しました。
- `gmailWatcher.js`を修正し、同名のファイルがある場合に保存時の名前を変える仕組みを追加しました。メッセージIDと内部日付を使用して一意のファイル名を生成します。
- `orderFileGenerator.js`を修正し、発注ファイル名の生成部分を変更して、元のファイル名（一意のファイル名）をそのまま使用するようにしました。
- `orderFileGenerator.js`を修正し、発注シートのA列に配送先ごとのリードタイムを加算した日付を設定する機能を追加しました。`data/ffmasta.csv`からリードタイムマスタを読み込み、配送先ごとにリードタイムを取得して集荷日に加算し、A列に配送日を設定します。
- `gmailWatcher.js`を修正し、最後にメールチェックを行った時間を記録して、次回のチェック時にはその時間以降のメールだけをチェックする機能を追加しました。これにより、毎回すべてのメールをチェックする必要がなくなり、処理効率が向上しました。
- `src/utils/addLeadTime.js`と`src/core/orderFileGenerator.js`を修正し、リードタイム計算時に日曜祝日をスキップするように変更しました。祝日情報は`https://holidays-jp.github.io/api/v1/[年]/date.json`のAPIから取得し、メモリ内にキャッシュするようにしました。これにより、より現実的な配送日計算が可能になりました。
- `axios`パッケージをインストールし、祝日情報を取得するためのHTTPリクエストを実装しました。
- 非同期処理に対応するため、リードタイム計算関連の関数を`async/await`パターンに修正しました。
- 発注書の自動印刷機能を実装しました。`config.js`にプリンタ設定を追加し、`src/utils/printFile.js`を作成して印刷機能を実装しました。
- `orderFileGenerator.js`を修正し、発注ファイル生成後に印刷処理を行うように変更しました。
- `gmailWatcher.js`を修正し、発注ファイル生成時に印刷機能を明示的に有効にするように変更しました。
- `config.js`にメール検索設定（`MAIL_SEARCH_CONFIG`）を追加し、検索対象となる差出人のメールアドレスを設定ファイルから読み込めるようにしました。
- `gmailWatcher.js`を修正し、ハードコードされていた差出人のメールアドレスの代わりに、`config.js`から設定を読み込むように変更しました。

## 請求書生成機能の改善（2025/4/18）
- スプレッドシートベースの請求書生成からHTMLテンプレートベースの生成方式に切り替えました。
- `templates/inv_temp.html`にHTMLベースの請求書テンプレートを実装しました。
- `src/utils/htmlTemplateRenderer.js`を新規作成し、HTMLテンプレートを動的データで置換する機能を実装しました。
- `src/utils/formatUtils.js`を新規作成し、数値や日付のフォーマット機能を実装しました。
- `config/invoice-config.js`を新規作成し、請求書生成に関する設定を一元管理できるようにしました。
- `src/utils/invoiceGenerator.js`を修正し、HTMLベースの請求書を生成するように変更しました。
- `src/tools/generateInvoice.js`を修正し、生成したHTMLファイルを自動的にブラウザで開く機能を追加しました。
- 請求書のPDFダウンロード機能を実装し、ブラウザ上でのPDF変換を可能にしました。

## 請求書生成機能の追加改善（2025/4/18 午後）
- 運賃計算を改善し、個口当たりの運賃に個口数を掛けて総運賃を計算するように変更しました。
- 請求書テンプレートに「個口当たり」の列を追加し、個口当たりの運賃と総運賃の両方を表示するようにしました。
- 請求番号と支払期限の表示を削除し、必要な情報のみをシンプルに表示するようにしました。
- 消費税10%の計算と表示を追加し、小計、消費税額、合計金額を明示的に表示するようにしました。
- 請求書のフッターに会社名、住所、電話番号、FAX番号を追加し、より公式な印象の請求書になるよう改善しました。
- `config/invoice-config.js`に消費税率や会社情報の設定を追加し、一元管理を強化しました。

## Puppeteerを使用したPDF請求書生成機能の実装（2025/4/18 夕方）
- Puppeteerを利用したサーバーサイドでの請求書PDF生成機能を実装しました。
- `src/utils/puppeteerInvoiceGenerator.js`を新規作成し、HTMLテンプレートからPDFを生成する機能を実装しました。
- 既存のHTML形式やPDFKit形式の請求書生成機能を残しつつ、Puppeteer形式を新たなデフォルトとして設定しました。
- `src/tools/generateInvoice.js`を更新し、`--puppeteer`オプションを追加。デフォルトをPuppeteer形式に変更しました。
- 請求書の生成結果ファイルを `billing/invoices` ディレクトリに保存するように変更しました。
- `node src/tools/generateInvoice.js 2025 04 --puppeteer` コマンドを実行し、請求書PDFが正常に生成されたことを確認しました。
- HTMLテンプレートのスタイル情報を完全に保持したPDF生成が可能になり、より高品質な請求書を生成できるようになりました。
- クライアントサイドでのPDF変換が不要になり、ユーザーはコマンド一つで直接PDF形式の請求書を生成できるようになりました。

## 配送単価判定ロジックの修正（2025/6/11）
- `excelProcessor.js`の配送単価判定ロジックを修正。
- 「同一配送先・同一集荷日（C1セル値）ごとの合計ケース数」で単価を決定し、5ケース未満はLow料金、5ケース以上は通常料金を全商品に適用する仕様に統一。
- caseCountMapのキー・参照をpickupDate（C1セル値）に統一し、totalCasesが常に0になる問題を解消。
- スプレッドシート記録時の単価が要件通りとなることを確認。
