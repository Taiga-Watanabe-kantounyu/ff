# Progress

## 現在の状況
- `gmailWatcher.js`の実行が成功し、Gmail APIへのアクセスが正常に行われた。
- ファイル名を`server.js`から`gmailWatcher.js`に変更。
- メールボックスの変更監視が正常に設定され、リアルタイムでの通知が可能になった。
- `gmailWatcher.js`と`excelProcessor.js`を連携し、Gmailの添付ファイルを自動的にGoogleスプレッドシートに転記するフローを実装。
- `excelProcessor.js`を`ff01-455323-24aa6cec6617.json`を使用して認証するように変更。
- `excelProcessor.js`を修正し、スプレッドシートの更新が成功した後に`processed_sheets.json`に処理済みのファイルを記録するように変更。
- `excelProcessor.js`を修正し、日本語のシート名に関連するエラー「Unable to parse range: 集荷依頼書!A:A」を解消するために、シート名を固定値「Sheet1」に設定。
- Excelファイルのデータを正しく処理し、C1セルから集荷日を取得してフォーマット仕様に従ってデータを整形する機能を実装。
- 処理済みのファイルを正しく記録し、重複処理を防止する機能が正常に動作することを確認。
- `excelProcessor.js`を修正し、C1セルから取得した集荷日がYYYY/MM/DD形式で正しく処理されるように改善。Excelの日付が内部的な数値表現（シリアル値）として取得される問題を解決。
- 発注仕様に基づいて、受注フォーマットのデータを発注用フォーマットに転記する機能を実装。
- 新たに`orderFileGenerator.js`を作成し、受注データから発注用ファイルを生成する機能を実装。
- お届け先の電話番号と住所を管理するための`deliveryMaster.json`を作成。
- お届け先マスタを管理するための`deliveryMasterManager.js`を作成し、追加/更新/削除/検索機能を実装。
- `gmailWatcher.js`を修正し、受信したExcelファイルから発注用ファイルも生成するように機能を追加。
- テスト用の受注ファイルを使用して発注ファイル生成機能をテストし、正常に動作することを確認。
- `orderFileGenerator.js`を修正し、発注用ファイル生成時にテンプレートファイル（saito_irai.xlsx）のセルスタイル情報を保持するように改善。これにより、発注書のレイアウト（フォント、罫線、色など）が正しく反映されるようになった。
- xlsxライブラリからexceljsライブラリに切り替え、文字サイズと罫線の問題を解決。
- CSVファイルからJSONマスタを生成する`csvToJson.js`を作成し、お届け先マスタ（deliveryMaster.json）を更新。電話番号情報も含めて変換するように対応。

## 残りの作業
- メールボックスの変更通知のさらなるテストと検証。
- スプレッドシートのシート名の設定を設定ファイルから読み込むように改善。
- エラーハンドリングの強化とログ出力の改善。
- コードの最適化とドキュメントの更新。
- お届け先マスタの拡充と管理機能の強化。

## 既知の問題
- スプレッドシートのシート名が現在ハードコードされており（「Sheet1」）、異なるシート名を使用する場合はコードの修正が必要。
- 日本語や特殊文字を含むシート名の処理に関する制限があり、現在は固定のシート名を使用することで回避している。
- お届け先マスタに登録されていないお届け先の場合、電話番号と住所が空欄になる。

## 最新の修正（2025/4/9）
- `excelProcessor.js`を修正し、スプレッドシートの情報を取得して指定したシート名が実際に存在するかどうかを確認する機能を追加。
- エラーハンドリングを強化し、より詳細なエラーメッセージを出力するように改善。
- `config.js`のスプレッドシートIDを修正し、正しいIDに更新。これにより、「Requested entity was not found.」エラーが解消された。
- `gmailWatcher.js`を修正し、同名のファイルがある場合に保存時の名前を変える仕組みを追加。メッセージIDと内部日付を使用して一意のファイル名を生成するようになった。
- `orderFileGenerator.js`を修正し、発注ファイル名の生成部分を変更して、元のファイル名（一意のファイル名）をそのまま使用するようにした。これにより、異なるメールで同名のファイルを受信した場合でも、ファイル名が重複することなく処理される。
- `orderFileGenerator.js`を修正し、発注シートのA列に配送先ごとのリードタイムを加算した日付を設定する機能を追加。`data/ffmasta.csv`からリードタイムマスタを読み込み、配送先ごとにリードタイムを取得して集荷日に加算し、A列に配送日を設定するようになった。例えば、「クージュー 厚木センター」のリードタイムは1日なので、集荷日が2025/04/11の場合、A列には2025/04/12が設定される。
- `gmailWatcher.js`を修正し、最後にメールチェックを行った時間を記録して、次回のチェック時にはその時間以降のメールだけをチェックする機能を追加。これにより、毎回すべてのメールをチェックする必要がなくなり、処理効率が向上した。最終チェック時間は`data/last_mail_check.json`に保存され、初回実行時や設定ファイルが存在しない場合は30日前の日付が初期値として設定される。
- `src/utils/addLeadTime.js`と`src/core/orderFileGenerator.js`を修正し、リードタイム計算時に日曜祝日をスキップするように変更。これにより、より現実的な配送日計算が可能になった。例えば、リードタイムが2日で集荷日が金曜日の場合、土日をスキップして火曜日が配送日となる。
- 祝日情報を`https://holidays-jp.github.io/api/v1/[年]/date.json`のAPIから取得し、メモリ内にキャッシュするように実装。これにより、ハードコードされた祝日リストを使用する必要がなくなり、将来の祝日変更にも柔軟に対応できるようになった。
- `axios`パッケージをインストールし、祝日情報を取得するためのHTTPリクエストを実装。
- 非同期処理に対応するため、リードタイム計算関連の関数を`async/await`パターンに修正。
- 発注書の自動印刷機能を実装。`config.js`にプリンタ設定（プリンタ名、印刷有効/無効、印刷部数）を追加。
- `src/utils/printFile.js`を作成し、PowerShellを使用してExcelファイルを直接印刷する機能を実装。
- `orderFileGenerator.js`を修正し、発注ファイル生成後に印刷処理を行うように変更。printAfterGeneration引数を追加して、印刷機能のオン/オフを切り替えられるようにした。
- `gmailWatcher.js`を修正し、発注ファイル生成時に印刷機能を明示的に有効にするように変更。
- `config.js`にメール検索設定（`MAIL_SEARCH_CONFIG`）を追加し、検索対象となる差出人のメールアドレスを設定ファイルから読み込めるようにした。
- `gmailWatcher.js`を修正し、ハードコードされていた差出人のメールアドレスの代わりに、`config.js`から設定を読み込むように変更した。これにより、メール検索の対象となる差出人を変更したい場合は、設定ファイルの値を変更するだけで済むようになった。

## HTML形式の請求書生成実装（2025/4/18）
- スプレッドシートベースの請求書生成システムからHTML形式の請求書生成システムに移行。
- `templates/inv_temp.html`にレスポンシブデザインのHTMLテンプレートを実装。
- `src/utils/htmlTemplateRenderer.js`を新規作成し、HTMLテンプレートエンジンを実装。これにより、動的データをテンプレートに適用できるようになった。
- `src/utils/formatUtils.js`を新規作成し、数値・通貨・日付のフォーマット機能を集約。
- `config/invoice-config.js`を新規作成し、請求書に関する設定を一元管理できるようにした。
- `src/utils/invoiceGenerator.js`を修正し、Google Sheetsへの出力からHTMLファイル生成に切り替えた。
- 請求書のPDFダウンロード機能を`html2pdf.js`ライブラリを使用して実装。
- `src/tools/generateInvoice.js`を修正し、生成されたHTMLファイルを自動的にブラウザで開く機能を追加（Windows、Mac、Linuxに対応）。
- 配送先ごとの小計表示、ランク別の集計表示など、より詳細な請求情報を表示できるように改善。

### 請求書生成に関する新機能
- 生成されたHTMLファイルは`billing/invoices`ディレクトリに保存
- ブラウザ上でのPDF変換とダウンロード機能
- モダンでレスポンシブなデザイン（異なる画面サイズに対応）
- 明確な構造と視覚的に優れたレイアウト

## 請求書生成機能の追加改善（2025/4/18 午後）
- 運賃計算ロジックを改善し、個口当たりの運賃に個口数を掛けて総運賃を計算するように変更。これにより、複数個口の配送に対して正確な運賃計算が可能になった。
- 請求書テンプレートに「個口当たり」の列を追加し、個口当たりの運賃と総運賃の両方を表示するようにした。これにより、運賃の内訳がより明確になった。
- 請求番号と支払期限の表示を削除し、必要な情報のみをシンプルに表示するようにした。
- 消費税10%の計算と表示を追加し、小計、消費税額、合計金額を明示的に表示するようにした。
- 請求書のフッターに会社名、住所、電話番号、FAX番号を追加し、より公式な印象の請求書になるよう改善した。
- `config/invoice-config.js`に以下の設定を追加：
  - 消費税率（10%）
  - 会社の詳細情報（住所、電話番号、FAX番号）
- `src/utils/invoiceGenerator.js`を修正し、消費税計算と会社情報の表示に対応。
- `templates/inv_temp.html`を修正し、レイアウトを調整して新しい情報を適切に表示するようにした。

### 請求書生成機能の改善点
- 個口当たりの運賃と総運賃の両方が明示されるようになり、運賃計算の透明性が向上
- 消費税が明示的に計算・表示されるようになり、法的要件に対応
- 会社情報が請求書に含まれるようになり、より公式な文書として使用可能
- 設定の一元管理が強化され、将来の変更や調整が容易に

## Puppeteerを使用したPDF請求書生成機能の実装（2025/4/18 夕方）
- Puppeteerパッケージをインストールし、ヘッドレスブラウザを使用したPDF生成環境を構築。
- `src/utils/puppeteerInvoiceGenerator.js`を新規作成し、以下の機能を実装：
  - HTMLファイルからPDFを生成する`generatePdfFromHtml`関数
  - HTMLテンプレートとデータからPDFを生成する`generatePdfFromTemplate`関数
  - 請求書データを使ってPDFを生成する`generateInvoicePdf`関数
- `src/tools/generateInvoice.js`を拡張し、Puppeteerを使用したPDF生成オプションを追加：
  - `--puppeteer`コマンドラインオプションの追加
  - デフォルト出力形式をPuppeteer PDFに変更
  - 既存のHTML形式（`--html`）とPDFKit形式（`--pdf`）の両方を引き続きサポート
- 一時HTMLファイルを保存するための`temp`ディレクトリを作成。

### Puppeteer PDF生成の利点
- クライアントサイドでのPDF変換が不要になり、ユーザーがブラウザで開いてPDFに変換する手順が省略できる
- HTMLテンプレートのCSSスタイリングが完全に維持され、高品質なPDFが生成できる
- ページサイズや余白などのPDF生成オプションを細かくコントロールできる
- ヘッドレスブラウザを使用するため、実際のブラウザをインストールせずにPDFを生成できる
- サーバーサイドでの自動PDF生成が可能になり、バッチ処理や定期実行に対応できる

### 実装のテスト結果
- `node src/tools/generateInvoice.js 2025 04 --puppeteer`コマンドを実行し、2025年4月の請求書PDFを正常に生成
- 請求書のHTMLおよびPDFファイルが `billing/invoices` ディレクトリに保存されることを確認しました
- 生成されたPDFはHTMLテンプレートのスタイルを完全に保持し、高品質な印刷用ドキュメントとして利用可能
- PDF生成処理は数秒以内に完了し、パフォーマンス面でも問題なし
